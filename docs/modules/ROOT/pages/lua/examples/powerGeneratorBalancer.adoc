= Paint Example

This code shows how to automatically control the generators according to the current load.

== Setup

You need small computer with a Lua CPU, a little bit RAM.
Then just plug in a Lua EEPROM and fill it with the code below.
Rename the generators to by analogy CoalGen1, CoalGen2, etc.

== Code

[source,Lua]
----
function round(exact, quantum)
    local quant,frac = math.modf(exact/quantum)
    return quantum * (quant + (frac > 0.5 and 1 or 0))
end

function sleep(delay)
 event.pull(delay)
end

nickname = "CoalGen"

num = 1
exit = false
while num < 200 and not exit do
  name = nickname .. tostring(num)
  id = component.findComponent(nickname .. tostring(num))
  gen = component.proxy(id)[1]
  if not gen then
    exit = true
  else
    print("Init:", name)
    num = num + 1
  end
end

target_efficiency = 90
average_workload = 100
wait_time = 0.5

function get_average_workload(circuit)
  current_workload = round(circuit.production / circuit.capacity * 100, 2)
  average_workload = average_workload + current_workload
  average_workload = average_workload / 2
  return average_workload
end

function main()
 iter = 0
 while true do
   iter = iter + 1
   for j = 1, num -1, 1 do
     name = nickname .. tostring(j)
     id = component.findComponent(name)
     generator = component.proxy(id)[1]
     name = generator.nick
     connectors = generator.getPowerConnectors(generator)
     connector = connectors[1]
     power_info = connector.GetPower(connector)
     circuit = power_info.getCircuit(power_info)
     print("Workload:", get_average_workload(circuit), "%")
     efficiency = round(circuit.consumption / circuit.production * 100, 2)
     print("Efficiency:", efficiency, "%")
     if not generator.standby then
       if efficiency < target_efficiency then
         generator.standby = true
       end 
     else
       if efficiency < target_efficiency and efficiency > 0  then
          print(name, efficiency, "%", " -> down")
          generator.standby = true
          sleep(wait_time)
       else
          print(name, efficiency, "%", " OK")
          generator.standby = false
          sleep(wait_time*3)
       end
     end
  end
  print(iter, "Workload:", average_workload,"%")
  sleep(wait_time) end
end

main()
print("Exited")
----

include::partial$lua_examples_footer.adoc[]